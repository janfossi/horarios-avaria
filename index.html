<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clínica Avaria · Horarios</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --muted:#7f8ea3; --text:#e6edf7; --accent:#2dd4bf; --danger:#ef4444; --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text)}
    header{display:flex; gap:12px; align-items:center; padding:20px 24px; border-bottom:1px solid #1f2937}
    header h1{font-size:18px; font-weight:700; margin:0}
    .container{max-width:1200px; margin:0 auto; padding:24px}
    .card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .grid{display:grid; gap:16px}
    @media (min-width: 1100px){ .grid{grid-template-columns: 1.2fr .8fr} }
    label{font-size:12px; color:var(--muted)}
    select,input[type="text"]{width:100%; padding:10px 12px; border-radius:12px; border:1px solid #263244; background:#0e141d; color:var(--text)}
    .controls{display:grid; grid-template-columns: 1.2fr .8fr 1fr 1fr; gap:12px; margin:8px 0 4px}
    .muted{color:var(--muted)}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#0d141c; border:1px solid #253145; font-size:12px}
    .flex{display:flex; gap:10px; align-items:center}
    .right{margin-left:auto}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid #283349; background:#0f1620; color:var(--text); cursor:pointer}
    .btn:hover{filter:brightness(1.08)}

    /* ==== Concurrency chart ==== */
    .chart{display:grid; grid-template-columns: 90px 1fr; gap:10px; margin-top:8px}
    .chart .ylabel{font-size:12px; color:var(--muted); text-align:right; padding-top:70px}
    .cols{display:grid; grid-template-columns: repeat(var(--cols), 1fr); gap:3px; align-items:end; height:120px; border:1px solid #263244; border-radius:12px; padding:8px; background:#0c121b}
    .col{height:6px; border-radius:4px; border:1px solid #263244}
    .col.ok{background:#114038}
    .col.mid{background:#0f3632}
    .col.low{background:#0c1f26}
    .col.over{background:#4e1b1b; outline:2px solid var(--danger)}

    /* ==== Gantt ==== */
    .gantt{display:grid; grid-template-columns: 170px 1fr; gap:8px; margin-top:18px}
    .names{display:flex; flex-direction:column; gap:8px; font-size:13px}
    .tracks{display:flex; flex-direction:column; gap:8px}
    .track{position:relative; width:100%; height:28px; border-radius:12px; border:1px solid #263244; background:#0c121b; overflow:hidden}
    .slotbar{position:absolute; top:4px; bottom:4px; border-radius:8px; display:flex; align-items:center; padding:0 8px; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; background:linear-gradient(180deg, #113148, #122033)}

    /* table */
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{padding:10px 8px; border-bottom:1px solid #1f2937}
    th{color:var(--muted); text-align:left; font-weight:600}
    .pill{padding:4px 8px; border-radius:999px; border:1px solid #283349; background:#0f1620; font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Clínica Avaria · Horarios</h1>
    <span class="tag">MVP</span>
    <div class="right flex">
      <span id="status" class="muted">Sin datos</span>
      <button id="reload" class="btn">Actualizar</button>
    </div>
  </header>

  <div class="container grid">
    <section class="card">
      <div class="controls">
        <div>
          <label>Endpoint JSON</label>
          <input id="endpoint" type="text" placeholder="Pega aquí la URL de tu Web App (doGet)" />
        </div>
        <div>
          <label>Día</label>
          <select id="selDia"></select>
        </div>
        <div>
          <label>Sucursal</label>
          <select id="selSucursal"></select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="apply" class="btn">Aplicar</button>
        </div>
      </div>

      <div class="flex" style="margin:6px 0 4px">
        <span id="capInfo" class="tag">Capacidad: –</span>
        <span id="peaks" class="tag">Pico: –</span>
        <span id="genAt" class="muted"></span>
      </div>

      <!-- Concurrency chart -->
      <div class="chart">
        <div class="ylabel">Concurrencia</div>
        <div class="cols" id="occCols"></div>
      </div>

      <!-- Gantt by professional -->
      <h3 style="margin:18px 0 8px">Turnos del día</h3>
      <div class="gantt">
        <div class="names" id="nameCol"></div>
        <div class="tracks" id="tracks"></div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">Detalle por profesional</h3>
      <table id="tbl">
        <thead>
          <tr>
            <th>Profesional</th>
            <th>Día</th>
            <th>Inicio</th>
            <th>Fin</th>
            <th>Duración</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

<script>
  // ==== CONFIG INICIAL ====
  const DEFAULT_ENDPOINT = "https://script.google.com/macros/s/AKfycby1wmrAeXSYE7uXhkJY345RJo1EXfouFYqhK-3mcq5v9uWoLYVksQdicLX71SeL7J7JgA/exec";
  const DIA_ORDEN = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
  const START_H = 8;  // hora de inicio de la grilla
  const END_H   = 21; // hora de término de la grilla
  const STEP_MIN = 15;

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const state = { data:null, dia:'Lunes', sucursal:'Las Condes' };

  function pad2(n){return String(n).padStart(2,'0')}
  function minutes(hhmm){ const [h,m]=hhmm.split(':').map(Number); return h*60+m; }
  function fmtDur(min){ const h=Math.floor(min/60), m=min%60; return `${h}h ${pad2(m)}m`; }
  function slots(){ const arr=[]; for(let h=START_H; h<END_H; h++) for(let m=0; m<60; m+=STEP_MIN) arr.push(`${pad2(h)}:${pad2(m)}`); return arr; }

  function loadUIChoices(data){
    const suc = Object.keys(data.capacities || { 'Las Condes':4, 'Providencia':6 });
    $('#selSucursal').innerHTML = suc.map(s=>`<option>${s}</option>`).join('');
    $('#selDia').innerHTML = DIA_ORDEN.map(d=>`<option>${d}</option>`).join('');
  }

  function render(){
    if(!state.data) return;
    const { capacities, generated_at, turnos } = state.data;
    $('#capInfo').textContent = `Capacidad ${state.sucursal}: ${capacities[state.sucursal] ?? '–'}`;
    $('#genAt').textContent = generated_at ? `Última publicación: ${new Date(generated_at).toLocaleString()}` : '';

    const dayTurns = turnos.filter(t=> t.sucursal===state.sucursal && t.dia===state.dia);

    // ==== Tabla detalle ====
    const tbody = $('#tbl tbody');
    tbody.innerHTML = dayTurns.map(t=>{
      const dur = minutes(t.hora_fin) - minutes(t.hora_inicio);
      return `<tr><td>${t.profesional}</td><td>${t.dia}</td><td>${t.hora_inicio}</td><td>${t.hora_fin}</td><td><span class="pill">${fmtDur(dur)}</span></td></tr>`;
    }).join('');

    // ==== Concurrency chart ====
    const cols = ((END_H-START_H)*60)/STEP_MIN;
    $('#occCols').style.setProperty('--cols', cols);
    const cap = capacities[state.sucursal] || 0;
    const slotList = slots();
    const map = new Map(slotList.map(s=>[s,0]));
    dayTurns.forEach(t=>{
      const start = minutes(t.hora_inicio); const end = minutes(t.hora_fin);
      slotList.forEach(s=>{ const mm=minutes(s); if(mm>=start && mm<end){ map.set(s, (map.get(s)||0)+1 ); } });
    });
    let peak = 0, overBlocks = 0;
    const bars = slotList.map(s=>{
      const v = map.get(s)||0; peak = Math.max(peak, v); if(v>cap) overBlocks++;
      const ratio = cap? Math.min(v/cap,1): 0; // altura relativa
      let cls = 'low'; if(ratio>0.66) cls='ok'; else if(ratio>0.33) cls='mid';
      if(v>cap) cls='over';
      return `<div class="col ${cls}" style="height:${Math.max(6, Math.round(ratio*100))}px" title="${s} · ${v}/${cap}"></div>`;
    }).join('');
    $('#occCols').innerHTML = bars;
    $('#peaks').textContent = `Pico: ${peak}/${cap} · Bloques sobre capacidad: ${overBlocks}`;

    // ==== Gantt por profesional ====
    const byProf = {};
    dayTurns.forEach(t=>{ (byProf[t.profesional]=byProf[t.profesional]||[]).push(t); });
    const names = Object.keys(byProf).sort();
    $('#nameCol').innerHTML = names.map(n=>`<div class="muted">${n}</div>`).join('');
    const base = START_H*60, total = (END_H-START_H)*60;
    const tracksHtml = names.map(n=>{
      const items = byProf[n].sort((a,b)=> minutes(a.hora_inicio)-minutes(b.hora_inicio)).map(t=>{
        const left = ((minutes(t.hora_inicio)-base)/total)*100;
        const width = ((minutes(t.hora_fin)-minutes(t.hora_inicio))/total)*100;
        return `<div class="slotbar" style="left:${left}%; width:${width}%;">${t.hora_inicio}–${t.hora_fin}</div>`;
      }).join('');
      return `<div class="track">${items}</div>`;
    }).join('');
    $('#tracks').innerHTML = tracksHtml || '<div class="muted">Sin turnos para esta combinación.</div>';
  }

  async function fetchData(url){
    try{
      $('#status').textContent = 'Cargando…';
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      state.data = data;
      $('#status').textContent = (data.status==='error')? `JSON con estado=error (${data.error_count})` : 'OK';
      loadUIChoices(data);
      render();
    }catch(err){ $('#status').textContent = 'Error al cargar: ' + err.message; console.error(err); }
  }

  // Eventos
  $('#apply').addEventListener('click',()=>{
    const url = $('#endpoint').value.trim();
    state.dia = $('#selDia').value;
    state.sucursal = $('#selSucursal').value;
    if(url) localStorage.setItem('avaria_endpoint', url);
    if(url) fetchData(url); else render();
  });
  $('#reload').addEventListener('click',()=>{ const url = $('#endpoint').value.trim(); if(url) fetchData(url); });
  $('#selDia').addEventListener('change',()=>{ state.dia = $('#selDia').value; render(); });
  $('#selSucursal').addEventListener('change',()=>{ state.sucursal = $('#selSucursal').value; render(); });

  // Boot
  const saved = localStorage.getItem('avaria_endpoint') || DEFAULT_ENDPOINT;
  $('#endpoint').value = saved; 
  fetchData(saved);
</script>
</body>
</html>
