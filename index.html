<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clínica Avaria · Horarios</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --muted:#7f8ea3; --text:#e6edf7;
      --line:#253145; --accent:#2dd4bf; --danger:#ef4444; --warn:#f59e0b;
      --prov:#0ea5e9; --lc:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; background:var(--bg); color:var(--text)}
    header{display:flex; gap:12px; align-items:center; padding:16px 20px; border-bottom:1px solid var(--line)}
    header h1{font-size:18px; margin:0; font-weight:700}
    .wrap{max-width:1400px; margin:0 auto; padding:20px}
    .controls{display:grid; grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr 1fr; gap:10px; margin-bottom:12px}
    label{font-size:12px; color:var(--muted)}
    select,input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0e141d; color:var(--text)}
    .seg{display:inline-flex; border:1px solid var(--line); border-radius:10px; overflow:hidden}
    .seg button{padding:10px 14px; background:#0f1620; color:var(--text); border:0; cursor:pointer}
    .seg button.active{background:#172233}
    .card{background:#111721; border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .kpis{display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 14px}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#0f1620; color:#c9d4e5; font-size:12px}
    h3{margin:8px 0 8px}

    /* Heatmap */
    .heat{display:grid; grid-template-columns: 110px 1fr; gap:8px}
    .heat .rows{display:flex; flex-direction:column; gap:6px}
    .heat .row{display:grid; grid-template-columns: repeat(var(--cols), 1fr); gap:1px}
    .heat .cell{height:18px; border-radius:3px}
    .heat .lab{font-size:12px; color:var(--muted); text-align:right; padding-right:6px}
    .axis{display:grid; grid-template-columns: 110px 1fr; gap:8px; margin-bottom:6px}
    .ticks{display:grid; grid-template-columns: repeat(var(--cols), 1fr); font-size:11px; color:#94a3b8}

    /* Bars daily */
    .bars{display:grid; grid-template-columns: 180px 1fr 100px; gap:10px; align-items:center}
    .barbg{height:16px; border:1px solid var(--line); border-radius:8px; background:#0c121b; position:relative}
    .barfill{position:absolute; top:2px; bottom:2px; left:2px; border-radius:6px; background:linear-gradient(180deg,#0b3a4d,#0b2a3d)}

    /* Gantt Día */
    .gantt{display:grid; grid-template-columns: 210px 1fr 90px; gap:10px}
    .names{display:flex; flex-direction:column; gap:10px; font-size:13px}
    .tracks{display:flex; flex-direction:column; gap:10px}
    .track{position:relative; height:32px; border:1px solid var(--line); border-radius:10px; background:#0c121b; overflow:hidden}
    .slot{position:absolute; top:5px; bottom:5px; border-radius:8px; background:linear-gradient(180deg,#113148,#122033); display:flex; align-items:center; padding:0 10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .rest{position:absolute; top:7px; bottom:7px; border-radius:6px; background:rgba(239,68,68,.25); border:1px dashed rgba(239,68,68,.6)}
    .dur{display:flex; align-items:center; justify-content:flex-end; font-size:12px; color:#cbd5e1}
    .axisDay{display:grid; grid-template-columns: 210px 1fr 90px; gap:10px; margin:6px 0}
    .ticksDay{display:grid; grid-template-columns: repeat(var(--cols), 1fr); font-size:11px; color:#94a3b8}

    /* Week Doctor */
    .weekdoc{display:grid; grid-template-columns: 120px repeat(7,1fr) 110px; gap:8px; align-items:center}
    .daycell{height:18px; border:1px solid var(--line); border-radius:6px; background:#0c121b; position:relative}
    .mini{position:absolute; top:2px; bottom:2px; border-radius:5px; opacity:.95}
    .prov{background:var(--prov)}
    .lc{background:var(--lc)}
    .legend{display:flex; gap:10px; align-items:center; font-size:12px; color:#b6c3d6}
    .lg{display:inline-flex; align-items:center; gap:6px}
    .sq{width:12px; height:12px; border-radius:3px; display:inline-block}
  </style>
</head>
<body>
  <header>
    <h1>Clínica Avaria · Horarios</h1>
    <span class="chip" id="status">Sin datos</span>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="controls">
        <div>
          <label>Endpoint JSON</label>
          <input id="endpoint" type="text" placeholder="URL Web App (doGet)" />
        </div>
        <div>
          <label>Vista</label>
          <div class="seg">
            <button id="vResumen" class="active">Resumen</button>
            <button id="vSucursal">Sucursal</button>
            <button id="vDoctor">Doctor</button>
          </div>
        </div>
        <div>
          <label>Sucursal</label>
          <select id="selSucursal"></select>
        </div>
        <div>
          <label>Doctor</label>
          <select id="selDoctor"></select>
        </div>
        <div>
          <label>Horario de operación</label>
          <div class="seg">
            <button data-range="8-21" class="r active">08–21</button>
            <button data-range="9-20" class="r">09–20</button>
          </div>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="reload" style="width:100%; padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#0f1620; color:var(--text); cursor:pointer">Actualizar</button>
        </div>
      </div>

      <div class="kpis" id="kpis"></div>

      <!-- ====== RESUMEN ====== -->
      <div id="viewResumen">
        <h3>Ocupación semanal (heatmap)</h3>
        <div class="axis"><div></div><div class="ticks" id="hmTicks"></div></div>
        <div class="heat">
          <div class="rows" id="hmLabels"></div>
          <div class="rows" id="hmRows"></div>
        </div>
        <h3 style="margin-top:16px">Horas usadas vs disponibles (por día)</h3>
        <div id="barsDaily"></div>
        <div style="margin-top:10px" class="legend">
          <div class="lg"><span class="sq" style="background:#0b3a4d"></span> Usadas</div>
          <div class="lg"><span class="sq" style="background:#334155"></span> Disponibles</div>
          <div class="lg"><span class="sq" style="background:#4e1b1b"></span> Overcap</div>
        </div>
      </div>

      <!-- ====== SUCURSAL ====== -->
      <div id="viewSucursal" style="display:none">
        <div class="legend" style="margin-bottom:8px">
          <div class="lg"><span class="sq" style="background:#113148"></span> Turno</div>
          <div class="lg"><span class="sq" style="background:rgba(239,68,68,.6)"></span> Descanso</div>
        </div>
        <div class="axisDay"><div></div><div class="ticksDay" id="dayTicks"></div><div></div></div>
        <div class="gantt">
          <div class="names" id="scNames"></div>
          <div class="tracks" id="scTracks"></div>
          <div class="names" id="scDur"></div>
        </div>
      </div>

      <!-- ====== DOCTOR ====== -->
      <div id="viewDoctor" style="display:none">
        <div class="legend" style="margin:6px 0 8px">
          <div class="lg"><span class="sq" style="background:var(--prov)"></span> Providencia</div>
          <div class="lg"><span class="sq" style="background:var(--lc)"></span> Las Condes</div>
        </div>
        <div id="wkDoc"></div>
      </div>
    </div>
  </div>

<script>
  const DEFAULT_ENDPOINT = "https://script.google.com/macros/s/AKfycby1wmrAeXSYE7uXhkJY345RJo1EXfouFYqhK-3mcq5v9uWoLYVksQdicLX71SeL7J7JgA/exec";
  let START_H = 8, END_H = 21; // configurable por UI
  const DIA_ORDEN = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];

  const $ = s => document.querySelector(s);
  const state = { data:null, sucursal:'', doctor:'', view:'resumen' };

  function pad2(n){return String(n).padStart(2,'0')}
  function minutes(hhmm){ const [h,m]=hhmm.split(':').map(Number); return h*60+m; }
  function slots(step){ const arr=[]; for(let h=START_H;h<END_H;h++){ for(let m=0;m<60;m+=step) arr.push(`${pad2(h)}:${pad2(m)}`);} return arr; }
  function fmtDur(min){ const h=Math.floor(min/60), m=min%60; return `${h}h ${pad2(m)}m`; }

  function loadChoices(){
    const caps = state.data.capacities || {}; const suc = Object.keys(caps);
    $('#selSucursal').innerHTML = `<option value="">Todas</option>` + suc.map(s=>`<option>${s}</option>`).join('');
    const docs = [...new Set((state.data.turnos||[]).map(t=>t.profesional))].sort();
    $('#selDoctor').innerHTML = `<option value="">Todos</option>` + docs.map(d=>`<option>${d}</option>`).join('');
  }

  function compute(step){
    const caps = state.data.capacities; const stepMin = state.data.block_minutes || step; const SLOTS = slots(stepMin);
    const per = {}; // per[sucursal][dia][slot] = concurrencia
    const perAll = {}; // perAll[dia][slot]

    const sucList = Object.keys(caps);
    sucList.forEach(s=>{ per[s] = {}; DIA_ORDEN.forEach(d=> per[s][d] = Object.fromEntries(SLOTS.map(x=>[x,0]))); });
    DIA_ORDEN.forEach(d=> perAll[d] = Object.fromEntries(SLOTS.map(x=>[x,0])));

    (state.data.turnos||[]).forEach(t=>{
      const S = per[t.sucursal]; if(!S) return;
      const start = minutes(t.hora_inicio), end = minutes(t.hora_fin);
      SLOTS.forEach(s=>{ const mm=minutes(s); if(mm>=start && mm<end){ S[t.dia][s]++; perAll[t.dia][s]++; }});
      if(t.descanso && t.descanso.inicio && t.descanso.fin){
        const rs=minutes(t.descanso.inicio), rf=minutes(t.descanso.fin);
        SLOTS.forEach(s=>{ const mm=minutes(s); if(mm>=rs && mm<rf){ S[t.dia][s] = Math.max(0,S[t.dia][s]-1); perAll[t.dia][s] = Math.max(0,perAll[t.dia][s]-1);} });
      }
    });
    return { SLOTS, per, perAll };
  }

  function kpiRender(){
    const caps = state.data.capacities; const { SLOTS, per } = compute(state.data.block_minutes||15);
    const hoursPerDay = (END_H-START_H);
    const cards=[];
    Object.keys(caps).forEach(s=>{
      let used=0, over=0; DIA_ORDEN.forEach(d=>{ SLOTS.forEach(x=>{ used += per[s][d][x]>0?1:0; if(per[s][d][x] > caps[s]) over++; }); });
      const usedH = used*(state.data.block_minutes||15)/60;
      const availH = hoursPerDay*caps[s]*7;
      cards.push(`<span class="chip"><b>${s}</b> · Usadas ${usedH.toFixed(1)}h / Disponibles ${availH}h · Utilización ${(usedH/availH*100).toFixed(0)}%${over?` · <span style='color:var(--danger)'>Overcap ${over}</span>`:''}</span>`);
    });
    $('#kpis').innerHTML = cards.join('');
  }

  // ===== Resumen (heatmap + barras) =====
  function renderResumen(){
    const step = state.data.block_minutes||15; const { SLOTS, per, perAll } = compute(step);
    const targetSuc = state.sucursal; // ''=todas
    const caps = state.data.capacities; const cols = Math.ceil((END_H-START_H)*60/60); // ticks cada 60min
    document.documentElement.style.setProperty('--cols', Math.ceil((END_H-START_H)*60/step));

    // Ticks
    const ticksHour = []; for(let h=START_H; h<END_H; h++) ticksHour.push(`${pad2(h)}:00`);
    $('#hmTicks').style.setProperty('--cols', ticksHour.length);
    $('#hmTicks').innerHTML = ticksHour.map(t=>`<div style="text-align:center">${t}</div>`).join('');

    // Labels y filas
    const scope = targetSuc ? [targetSuc] : Object.keys(caps);
    $('#hmLabels').innerHTML = scope.map(s=>`<div class="lab">${s}</div>`).concat(['<div class="lab">Total</div>']).join('');

    const rowsHtml = scope.map(s=>{
      const cells = DIA_ORDEN.map(d=>{
        return `<div class="row" style="--cols:${SLOTS.length}">`+
          SLOTS.map((x)=>{
            const v = per[s][d][x]; const pct = caps[s]? v/caps[s] : 0;
            const c = v>caps[s] ? 'rgba(239,68,68,.7)' : `rgba(45,212,191,${Math.max(.08, pct)})`;
            return `<div class="cell" title="${d} ${x} · ${v}/${caps[s]}" style="background:${c}"></div>`;
          }).join('')+`</div>`;
      }).join('');
      return cells;
    }).join('');

    // Total (todas sucursales)
    const totalRow = DIA_ORDEN.map(d=>{
      return `<div class="row" style="--cols:${SLOTS.length}">`+
        SLOTS.map((x)=>{
          const v = perAll[d][x]; const capTot = scope.reduce((a,s)=> a + (caps[s]||0), 0);
          const c = v>capTot ? 'rgba(239,68,68,.7)' : `rgba(148,163,184,${Math.max(.08, v/(capTot||1))})`;
          return `<div class="cell" title="${d} ${x} · ${v}/${capTot}" style="background:${c}"></div>`;
        }).join('')+`</div>`;
    }).join('');

    $('#hmRows').innerHTML = rowsHtml + totalRow;

    // Barras diarias
    const bars = [];
    DIA_ORDEN.forEach(d=>{
      let used=0, capTot=0; if(targetSuc){ capTot = (END_H-START_H)*caps[targetSuc];
        Object.keys(per[targetSuc][d]).forEach(x=>{ if(per[targetSuc][d][x]>0) used++; });
      } else { capTot = (END_H-START_H)*scope.reduce((a,s)=>a+caps[s],0);
        const acc = {}; SLOTS.forEach(x=>{ acc[x]=0; scope.forEach(s=> acc[x]+=per[s][d][x]); if(acc[x]>0) used++; });
      }
      const usedH = used*step/60; const availH = capTot; const pct = availH? usedH/availH:0;
      bars.push(`<div class="bars"><div class="lab">${d}</div><div class="barbg"><div class="barfill" style="width:${pct*100}%"></div></div><div style="text-align:right">${usedH.toFixed(1)} / ${availH}h</div></div>`);
    });
    $('#barsDaily').innerHTML = bars.join('');

    kpiRender();
  }

  // ===== Sucursal (día → Gantt) =====
  function renderSucursal(){
    const caps = state.data.capacities; const suc = state.sucursal || Object.keys(caps)[0];
    const list = (state.data.turnos||[]).filter(t=>t.sucursal===suc).sort((a,b)=> a.profesional.localeCompare(b.profesional));
    // ticks
    const step = state.data.block_minutes||15; const SLOTS = slots(step);
    $('#dayTicks').style.setProperty('--cols', SLOTS.length);
    $('#dayTicks').innerHTML = SLOTS.map((s,i)=> i%4===0? `<div style='text-align:center'>${s}</div>`: '<div></div>').join('');

    // rows
    const names = [...new Set(list.map(t=>t.profesional))];
    $('#scNames').innerHTML = names.map(n=>`<div class="lab" style="text-align:right">${n}</div>`).join('');
    const base=START_H*60, total=(END_H-START_H)*60;
    const trackHtml = names.map(n=>{
      const turns = list.filter(x=>x.profesional===n).sort((a,b)=> minutes(a.hora_inicio)-minutes(b.hora_inicio));
      const durDay = turns.reduce((acc,t)=> acc + (t.min_efectivos!=null ? t.min_efectivos : (minutes(t.hora_fin)-minutes(t.hora_inicio) - (t.descanso? (minutes(t.descanso.fin)-minutes(t.descanso.inicio)):0))), 0);
      const slots = turns.map(t=>{
        const left = ((minutes(t.hora_inicio)-base)/total)*100; const width = ((minutes(t.hora_fin)-minutes(t.hora_inicio))/total)*100;
        const hasRest = t.descanso && t.descanso.inicio && t.descanso.fin;
        const rL = hasRest? ((minutes(t.descanso.inicio)-base)/total)*100:0; const rW = hasRest? ((minutes(t.descanso.fin)-minutes(t.descanso.inicio))/total)*100:0;
        const tip = `${t.hora_inicio}–${t.hora_fin}` + (hasRest? ` · descanso ${t.descanso.inicio}–${t.descanso.fin}`:'');
        return `<div class="slot" style="left:${left}%; width:${width}%" title="${tip}">${t.hora_inicio}–${t.hora_fin}</div>${hasRest?`<div class='rest' style='left:${rL}%; width:${rW}%'></div>`:''}`;
      }).join('');
      return `<div class="track">${slots}</div><div class="dur">${fmtDur(durDay)}</div>`;
    }).join('');
    $('#scTracks').innerHTML = trackHtml || '<div class="lab">Sin turnos</div>';
  }

  // ===== Doctor (semana) =====
  function renderDoctor(){
    const dname = state.doctor; if(!dname){ $('#wkDoc').innerHTML = '<div class="lab">Selecciona un doctor.</div>'; return; }
    const items = (state.data.turnos||[]).filter(t=>t.profesional===dname);
    let total=0; const head = `<div></div>${DIA_ORDEN.map(d=>`<div class='lab' style='text-align:center'>${d}</div>`).join('')}<div class='lab' style='text-align:right'>Total</div>`;
    const step = state.data.block_minutes||15; const SLOTS = slots(step); const base=START_H*60, widthTot=(END_H-START_H)*60;
    const row = DIA_ORDEN.map(d=>{
      const per = items.filter(x=>x.dia===d);
      const cell = `<div class='daycell'>${per.map(t=>{ const l=((minutes(t.hora_inicio)-base)/widthTot)*100; const w=((minutes(t.hora_fin)-minutes(t.hora_inicio))/widthTot)*100; total += (t.min_efectivos!=null?t.min_efectivos:(minutes(t.hora_fin)-minutes(t.hora_inicio) - (t.descanso? (minutes(t.descanso.fin)-minutes(t.descanso.inicio)):0))); const cls=(t.sucursal==='Providencia')?'prov':'lc'; return `<div class='mini ${cls}' style='left:${l}%; width:${w}%' title='${t.sucursal} · ${t.hora_inicio}–${t.hora_fin}'></div>`; }).join('')}</div>`;
      return cell;
    }).join('');
    $('#wkDoc').innerHTML = `<div class='weekdoc'>${head}<div class='lab'>${dname}</div>${row}<div style='text-align:right'><span class='chip'>${fmtDur(total)}</span></div></div>`;
  }

  function render(){
    if(!state.data) return;
    // Deshabilitación lógica
    if(state.view==='resumen'){
      $('#selSucursal').disabled = false; $('#selDoctor').disabled = false;
      $('#viewResumen').style.display='block'; $('#viewSucursal').style.display='none'; $('#viewDoctor').style.display='none'; renderResumen();
    } else if(state.view==='sucursal'){
      $('#selDoctor').disabled = false; $('#selSucursal').disabled = false;
      $('#viewResumen').style.display='none'; $('#viewSucursal').style.display='block'; $('#viewDoctor').style.display='none'; renderSucursal();
    } else { // doctor
      $('#selDoctor').disabled = false; $('#selSucursal').disabled = true;
      $('#viewResumen').style.display='none'; $('#viewSucursal').style.display='none'; $('#viewDoctor').style.display='block'; renderDoctor();
    }
    kpiRender();
  }

  async function fetchData(url){
    try{
      $('#status').textContent = 'Cargando…';
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      state.data = await res.json();
      $('#status').textContent = 'OK';
      loadChoices();
      render();
    }catch(e){ $('#status').textContent = 'Error: '+e.message; console.error(e); }
  }

  // Eventos
  document.querySelectorAll('.seg .r').forEach(b=> b.addEventListener('click', (e)=>{
    document.querySelectorAll('.seg .r').forEach(x=>x.classList.remove('active'));
    e.currentTarget.classList.add('active');
    const [a,bh] = e.currentTarget.dataset.range.split('-').map(Number); START_H=a; END_H=bh; render();
  }));
  $('#vResumen').addEventListener('click',()=>{ ['vResumen','vSucursal','vDoctor'].forEach(id=>$('#'+id).classList.remove('active')); $('#vResumen').classList.add('active'); state.view='resumen'; render(); });
  $('#vSucursal').addEventListener('click',()=>{ ['vResumen','vSucursal','vDoctor'].forEach(id=>$('#'+id).classList.remove('active')); $('#vSucursal').classList.add('active'); state.view='sucursal'; render(); });
  $('#vDoctor').addEventListener('click',()=>{ ['vResumen','vSucursal','vDoctor'].forEach(id=>$('#'+id).classList.remove('active')); $('#vDoctor').classList.add('active'); state.view='doctor'; render(); });
  $('#selSucursal').addEventListener('change',()=>{ state.sucursal = $('#selSucursal').value; render(); });
  $('#selDoctor').addEventListener('change',()=>{ state.doctor = $('#selDoctor').value; if(state.view!=='doctor' && state.doctor) { state.view='doctor'; ['vResumen','vSucursal','vDoctor'].forEach(id=>$('#'+id).classList.remove('active')); $('#vDoctor').classList.add('active'); } render(); });
  $('#reload').addEventListener('click',()=>{ const url = $('#endpoint').value.trim(); if(url){ localStorage.setItem('avaria_endpoint', url); fetchData(url); } });

  // Boot
  const saved = localStorage.getItem('avaria_endpoint') || DEFAULT_ENDPOINT; $('#endpoint').value = saved; fetchData(saved);
</script>
</body>
</html>
