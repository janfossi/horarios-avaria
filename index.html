<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clínica Avaria · Horarios</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121821; --muted:#7f8ea3; --text:#e6edf7; --accent:#2dd4bf; --danger:#ef4444; --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text)}
    header{display:flex; gap:12px; align-items:center; padding:20px 24px; border-bottom:1px solid #1f2937}
    header h1{font-size:18px; font-weight:700; margin:0}
    .container{max-width:1100px; margin:0 auto; padding:24px}
    .card{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .grid{display:grid; gap:16px}
    @media (min-width: 980px){ .grid{grid-template-columns: 1.1fr .9fr} }
    label{font-size:12px; color:var(--muted)}
    select,input[type="text"]{width:100%; padding:10px 12px; border-radius:12px; border:1px solid #263244; background:#0e141d; color:var(--text)}
    .row{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
    .controls{display:grid; grid-template-columns: 1.2fr .8fr 1fr 1fr; gap:12px; margin:8px 0 4px}
    .muted{color:var(--muted)}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#0d141c; border:1px solid #253145; font-size:12px}
    .flex{display:flex; gap:10px; align-items:center}
    .right{margin-left:auto}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid #283349; background:#0f1620; color:var(--text); cursor:pointer}
    .btn:hover{filter:brightness(1.1)}

    /* timeline */
    .timeline{display:grid; grid-template-columns: 80px 1fr; gap:8px}
    .scale{display:grid; grid-template-rows: repeat(var(--rows), 24px); gap:4px}
    .scale div{font-size:11px; color:var(--muted); text-align:right; padding-right:6px}
    .bars{position:relative; border:1px solid #263244; border-radius:12px; padding:10px; background:#0c121b;}
    .bar{position:relative; height:22px; border-radius:8px; margin:4px 0; display:flex; align-items:center; padding:0 8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .bar .badge{font-size:11px; opacity:.9}

    /* occupancy heat */
    .heat{display:grid; grid-template-columns: 80px 1fr; gap:8px; margin-top:16px}
    .heat .cells{display:grid; grid-template-columns: repeat(var(--cols), 1fr); gap:2px; align-items:center}
    .cell{height:26px; border-radius:6px; border:1px solid #263244; display:flex; align-items:center; justify-content:center; font-size:11px}
    .c0{background:#0c141e}
    .c1{background:#0c1f26}
    .c2{background:#0e2a2c}
    .c3{background:#0f3632}
    .c4{background:#114038}
    .c5{background:#3a1a1a}
    .c6{background:#551b1b}
    .over{outline:2px solid var(--danger)}

    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{padding:10px 8px; border-bottom:1px solid #1f2937}
    th{color:var(--muted); text-align:left; font-weight:600}
    .pill{padding:4px 8px; border-radius:999px; border:1px solid #283349; background:#0f1620; font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Clínica Avaria · Horarios</h1>
    <span class="tag">MVP</span>
    <div class="right flex">
      <span id="status" class="muted">Sin datos</span>
      <button id="reload" class="btn">Actualizar</button>
    </div>
  </header>

  <div class="container grid">
    <section class="card">
      <div class="controls">
        <div>
          <label>Endpoint JSON</label>
          <input id="endpoint" type="text" placeholder="Pega aquí la URL de tu Web App (doGet)" />
        </div>
        <div>
          <label>Día</label>
          <select id="selDia"></select>
        </div>
        <div>
          <label>Sucursal</label>
          <select id="selSucursal"></select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="apply" class="btn">Aplicar</button>
        </div>
      </div>

      <div class="flex" style="margin:6px 0 14px">
        <span id="capInfo" class="tag">Capacidad: –</span>
        <span id="genAt" class="muted"></span>
      </div>

      <div class="heat">
        <div class="scale" id="heatScale"></div>
        <div class="cells" id="heatCells"></div>
      </div>

      <h3 style="margin:18px 0 8px">Turnos del día</h3>
      <div class="timeline">
        <div class="scale" id="timeScale"></div>
        <div id="bars" class="bars"></div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">Detalle por profesional</h3>
      <table id="tbl">
        <thead>
          <tr>
            <th>Profesional</th>
            <th>Día</th>
            <th>Inicio</th>
            <th>Fin</th>
            <th>Duración</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

<script>
  // ==== CONFIG INICIAL (puedes dejar tu URL aquí para auto-cargar) ====
  const DEFAULT_ENDPOINT = "https://script.google.com/macros/s/AKfycby1wmrAeXSYE7uXhkJY345RJo1EXfouFYqhK-3mcq5v9uWoLYVksQdicLX71SeL7J7JgA/exec";
  const DIA_ORDEN = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
  const START_H = 8;  // hora de inicio de la grilla
  const END_H   = 21; // hora de término de la grilla
  const STEP_MIN = 15;

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const state = { data:null, dia:'Lunes', sucursal:'Las Condes' };

  function pad2(n){return String(n).padStart(2,'0')}
  function minutes(hhmm){ const [h,m]=hhmm.split(':').map(Number); return h*60+m; }
  function fmtDur(min){ const h=Math.floor(min/60), m=min%60; return `${h}h ${pad2(m)}m`; }

  function buildTimeLabels(){
    const rows = ((END_H-START_H)*60)/STEP_MIN;
    $('#timeScale').style.setProperty('--rows', rows);
    $('#heatScale').style.setProperty('--rows', 1);
    const scale = [];
    for(let h=START_H; h<END_H; h++){
      scale.push(`<div>${pad2(h)}:00</div>`);
      if(STEP_MIN===15){ scale.push('<div></div>'); scale.push('<div></div>'); scale.push('<div></div>'); }
    }
    $('#timeScale').innerHTML = scale.join('');
    // Heat scale (una sola fila con etiqueta izquierda)
    $('#heatScale').innerHTML = `<div class="muted">Concurrencia</div>`;
  }

  function slots(){
    const arr=[]; for(let h=START_H; h<END_H; h++) for(let m=0; m<60; m+=STEP_MIN) arr.push(`${pad2(h)}:${pad2(m)}`); return arr;
  }

  function loadUIChoices(data){
    // sucursales
    const suc = Object.keys(data.capacities || { 'Las Condes':4, 'Providencia':6 });
    $('#selSucursal').innerHTML = suc.map(s=>`<option>${s}</option>`).join('');
    // días
    $('#selDia').innerHTML = DIA_ORDEN.map(d=>`<option>${d}</option>`).join('');
  }

  function render(){
    if(!state.data) return;
    const { capacities, generated_at, turnos } = state.data;
    $('#capInfo').textContent = `Capacidad ${state.sucursal}: ${capacities[state.sucursal] ?? '–'}`;
    $('#genAt').textContent = generated_at ? `Última publicación: ${new Date(generated_at).toLocaleString()}` : '';

    const dayTurns = turnos.filter(t=> t.sucursal===state.sucursal && t.dia===state.dia);
    // Tabla detalle
    const tbody = $('#tbl tbody');
    tbody.innerHTML = dayTurns.map(t=>{
      const dur = minutes(t.hora_fin) - minutes(t.hora_inicio);
      return `<tr><td>${t.profesional}</td><td>${t.dia}</td><td>${t.hora_inicio}</td><td>${t.hora_fin}</td><td><span class="pill">${fmtDur(dur)}</span></td></tr>`;
    }).join('');

    // Barras por profesional (timeline simple)
    const container = $('#bars'); container.innerHTML='';
    const base = START_H*60;
    dayTurns.forEach(t=>{
      const left = ((minutes(t.hora_inicio)-base) / ((END_H-START_H)*60)) * 100;
      const width = ((minutes(t.hora_fin)-minutes(t.hora_inicio)) / ((END_H-START_H)*60)) * 100;
      const el = document.createElement('div');
      el.className = 'bar';
      el.style.background = 'linear-gradient(180deg, #113148, #122033)';
      el.style.width = width + '%';
      el.style.marginLeft = left + '%';
      el.innerHTML = `<span class="badge">${t.profesional} · ${t.hora_inicio}–${t.hora_fin}</span>`;
      container.appendChild(el);
    });

    // Heat de concurrencia por bloque
    const cols = ((END_H-START_H)*60)/STEP_MIN;
    $('#heatCells').style.setProperty('--cols', cols);
    const cap = capacities[state.sucursal] || 0;
    const map = new Map();
    const slotList = slots();
    slotList.forEach(s=>map.set(s,0));
    dayTurns.forEach(t=>{
      const start = minutes(t.hora_inicio); const end = minutes(t.hora_fin);
      slotList.forEach(s=>{ const mm=minutes(s); if(mm>=start && mm<end){ map.set(s, (map.get(s)||0)+1 ); } });
    });
    const cells = slotList.map(s=>{
      const v = map.get(s)||0;
      const over = v>cap ? ' over' : '';
      const cls = 'c'+Math.min(v,6);
      return `<div class="cell ${cls}${over}" title="${s} · ${v}/${cap}">${v}</div>`;
    }).join('');
    $('#heatCells').innerHTML = cells;
  }

  async function fetchData(url){
    $('#status').textContent = 'Cargando…';
    const res = await fetch(url);
    const data = await res.json();
    if(data.status==='error'){
      $('#status').textContent = `JSON con estado=error (${data.error_count})`;
    } else {
      $('#status').textContent = 'OK';
    }
    state.data = data;
    loadUIChoices(data);
    render();
  }

  // Eventos
  $('#apply').addEventListener('click',()=>{
    const url = $('#endpoint').value.trim();
    state.dia = $('#selDia').value;
    state.sucursal = $('#selSucursal').value;
    if(url) localStorage.setItem('avaria_endpoint', url);
    if(url) fetchData(url); else render();
  });
  $('#reload').addEventListener('click',()=>{
    const url = $('#endpoint').value.trim(); if(url) fetchData(url);
  });
  $('#selDia').addEventListener('change',()=>{ state.dia = $('#selDia').value; render(); });
  $('#selSucursal').addEventListener('change',()=>{ state.sucursal = $('#selSucursal').value; render(); });

  // Boot
  buildTimeLabels();
  const saved = localStorage.getItem('avaria_endpoint') || DEFAULT_ENDPOINT;
  if(saved){ $('#endpoint').value = saved; fetchData(saved); }
  else { $('#endpoint').value = DEFAULT_ENDPOINT; }
</script>
</body>
</html>
